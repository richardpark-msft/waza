{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/spboyer/waza/main/schemas/task.schema.json",
  "title": "Waza Task Definition",
  "description": "Schema for waza task YAML files that define individual evaluation test cases.",
  "type": "object",
  "required": ["id", "name", "inputs"],
  "properties": {
    "id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique identifier for this task."
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Display name for this task."
    },
    "description": {
      "type": "string",
      "description": "Human-readable summary of what this task tests."
    },
    "enabled": {
      "type": "boolean",
      "description": "Whether this task is active. Defaults to true when omitted."
    },
    "context_dir": {
      "type": "string",
      "description": "Override the context/fixtures directory for this task."
    },
    "timeout_seconds": {
      "type": "integer",
      "minimum": 1,
      "description": "Per-task timeout in seconds, overriding the eval-level default."
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Tags for filtering or grouping tasks."
    },
    "inputs": {
      "$ref": "#/$defs/inputs"
    },
    "expected": {
      "$ref": "#/$defs/expected"
    },
    "graders": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/validatorInline"
      },
      "description": "Task-level graders applied to this task's output."
    }
  },
  "$defs": {
    "inputs": {
      "type": "object",
      "required": ["prompt"],
      "description": "Input stimulus for the task.",
      "properties": {
        "prompt": {
          "type": "string",
          "description": "The prompt message sent to the agent."
        },
        "context": {
          "type": "object",
          "description": "Arbitrary key-value metadata passed to the agent."
        },
        "files": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/resourceRef"
          },
          "description": "File references or inline content provided to the agent."
        },
        "environment": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Environment variables set during task execution."
        }
      }
    },
    "resourceRef": {
      "type": "object",
      "description": "A file reference by path or inline content.",
      "properties": {
        "path": {
          "type": "string",
          "description": "Path to the file relative to context_dir."
        },
        "content": {
          "type": "string",
          "description": "Inline file content."
        }
      }
    },
    "expected": {
      "type": "object",
      "description": "Expected outcomes and constraints for grading.",
      "properties": {
        "outcomes": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/outcomeSpec"
          },
          "description": "Structured outcome expectations."
        },
        "tool_calls": {
          "type": "object",
          "description": "Expected tool call patterns."
        },
        "behavior": {
          "$ref": "#/$defs/behaviorRules"
        },
        "output_contains": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Strings that must appear in the agent output."
        },
        "output_not_contains": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Strings that must not appear in the agent output."
        },
        "should_trigger": {
          "type": "boolean",
          "description": "Whether the skill should be triggered."
        }
      }
    },
    "outcomeSpec": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "description": "Category of the expected outcome."
        },
        "value": {
          "description": "Expected value for this outcome."
        },
        "condition": {
          "type": "string",
          "description": "Predicate expression for this outcome."
        }
      }
    },
    "behaviorRules": {
      "type": "object",
      "description": "Behavioral constraints for the agent during this task.",
      "properties": {
        "max_tool_calls": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of tool invocations allowed."
        },
        "max_iterations": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of conversation rounds."
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum total token usage allowed."
        },
        "required_tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tools that must be used during execution."
        },
        "forbidden_tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tools that must not be used during execution."
        }
      }
    },
    "validatorInline": {
      "type": "object",
      "required": ["name"],
      "description": "A grader/validator embedded in a task.",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Identifier for this grader."
        },
        "type": {
          "type": "string",
          "enum": [
            "code",
            "prompt",
            "regex",
            "file",
            "keyword",
            "json_schema",
            "program",
            "behavior",
            "action_sequence",
            "skill_invocation",
            "diff",
            "tool_constraint"
          ],
          "description": "The grader type."
        },
        "assertions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Assertion expressions evaluated by the grader."
        },
        "rubric": {
          "type": "string",
          "description": "Evaluation rubric text (used by prompt graders)."
        },
        "weight": {
          "type": "number",
          "description": "Relative weight of this grader's score."
        },
        "config": {
          "type": "object",
          "description": "Type-specific configuration for this grader."
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "code" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/codeGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "regex" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/regexGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "file" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/fileGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "keyword" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/keywordGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "behavior" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/behaviorGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "action_sequence" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/actionSequenceGraderConfig" }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "skill_invocation" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/skillInvocationGraderConfig" }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "tool_constraint" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/toolConstraintGraderConfig" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "prompt" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/promptGraderConfig" }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "json_schema" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/jsonSchemaGraderConfig" }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "program" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/programGraderConfig" }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "diff" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "config": { "$ref": "#/$defs/diffGraderConfig" }
            },
            "required": ["config"]
          }
        }
      ]
    },
    "codeGraderConfig": {
      "type": "object",
      "required": ["assertions"],
      "additionalProperties": false,
      "properties": {
        "assertions": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "language": {
          "type": "string",
          "enum": ["python", "javascript"],
          "default": "python"
        }
      }
    },
    "regexGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["must_match"] },
        { "required": ["must_not_match"] }
      ],
      "properties": {
        "must_match": {
          "type": "array",
          "items": { "type": "string" }
        },
        "must_not_match": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "fileGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["must_exist"] },
        { "required": ["must_not_exist"] },
        { "required": ["content_patterns"] }
      ],
      "properties": {
        "must_exist": {
          "type": "array",
          "items": { "type": "string" }
        },
        "must_not_exist": {
          "type": "array",
          "items": { "type": "string" }
        },
        "content_patterns": {
          "type": "array",
          "items": { "$ref": "#/$defs/fileContentPattern" }
        }
      }
    },
    "fileContentPattern": {
      "type": "object",
      "required": ["path"],
      "additionalProperties": false,
      "anyOf": [
        { "required": ["path", "must_match"] },
        { "required": ["path", "must_not_match"] }
      ],
      "properties": {
        "path": {
          "type": "string",
          "minLength": 1
        },
        "must_match": {
          "type": "array",
          "items": { "type": "string" }
        },
        "must_not_match": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "keywordGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["must_contain"] },
        { "required": ["must_not_contain"] }
      ],
      "properties": {
        "must_contain": {
          "type": "array",
          "items": { "type": "string" }
        },
        "must_not_contain": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "behaviorGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["max_tool_calls"] },
        { "required": ["max_tokens"] },
        { "required": ["required_tools"] },
        { "required": ["forbidden_tools"] },
        { "required": ["max_duration_ms"] }
      ],
      "properties": {
        "max_tool_calls": {
          "type": "integer",
          "minimum": 0
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "required_tools": {
          "type": "array",
          "items": { "type": "string" }
        },
        "forbidden_tools": {
          "type": "array",
          "items": { "type": "string" }
        },
        "max_duration_ms": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "actionSequenceGraderConfig": {
      "type": "object",
      "required": ["matching_mode", "expected_actions"],
      "additionalProperties": false,
      "properties": {
        "matching_mode": {
          "type": "string",
          "enum": ["exact_match", "in_order_match", "any_order_match"]
        },
        "expected_actions": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        }
      }
    },
    "skillInvocationGraderConfig": {
      "type": "object",
      "required": ["mode", "required_skills"],
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["exact_match", "in_order", "any_order"]
        },
        "required_skills": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "allow_extra": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "toolConstraintGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["expect_tools"] },
        { "required": ["reject_tools"] },
        { "required": ["max_turns"] },
        { "required": ["max_tokens"] }
      ],
      "properties": {
        "expect_tools": {
          "type": "array",
          "items": { "type": "string" }
        },
        "reject_tools": {
          "type": "array",
          "items": { "type": "string" }
        },
        "max_turns": {
          "type": "integer",
          "minimum": 1
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "promptGraderConfig": {
      "type": "object",
      "required": ["prompt"],
      "additionalProperties": false,
      "properties": {
        "prompt": {
          "type": "string",
          "minLength": 1
        },
        "model": {
          "type": "string"
        },
        "continue_session": {
          "type": "boolean",
          "default": false
        },
        "mode": {
          "type": "string",
          "enum": ["independent", "pairwise"],
          "default": "independent"
        }
      }
    },
    "jsonSchemaGraderConfig": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [
        { "required": ["schema"] },
        { "required": ["schema_file"] }
      ],
      "properties": {
        "schema": {
          "type": "object"
        },
        "schema_file": {
          "type": "string"
        }
      }
    },
    "programGraderConfig": {
      "type": "object",
      "required": ["command"],
      "additionalProperties": false,
      "properties": {
        "command": {
          "type": "string",
          "minLength": 1
        },
        "args": {
          "type": "array",
          "items": { "type": "string" }
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "default": 30
        }
      }
    },
    "diffGraderConfig": {
      "type": "object",
      "required": ["expected_files"],
      "additionalProperties": false,
      "properties": {
        "expected_files": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/expectedFile" }
        },
        "context_dir": {
          "type": "string"
        }
      }
    },
    "expectedFile": {
      "type": "object",
      "required": ["path"],
      "additionalProperties": false,
      "anyOf": [
        { "required": ["path", "snapshot"] },
        { "required": ["path", "contains"] }
      ],
      "properties": {
        "path": {
          "type": "string",
          "minLength": 1
        },
        "snapshot": {
          "type": "string"
        },
        "contains": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
